import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D


def get_data():
    """
    从你的日志中提取的数据。
    x_ca: 坐标点
    a_idx: 聚类索引 (cluster IDs)
    """
    # 1. 坐标点 x_ca (Batch 0)
    # 为了保持脚本整洁，这里包含完整数据
    x_ca = np.array([
        [9.8911, -5.8318, -17.3436], [9.2471, -3.7068, -20.3056], [6.9961, -0.7508, -20.0096],
        [5.1011, 0.6062, -23.0426],
        [4.5171, 4.3512, -23.3826], [5.1391, 7.7912, -21.8556], [5.3961, 8.2962, -18.1136], [2.3881, 10.3352, -16.9146],
        [2.1421, 10.7912, -13.1066], [-1.1129, 9.9872, -11.3586], [-3.1979, 12.1752, -8.9836],
        [-3.9879, 9.1212, -6.8746],
        [-2.4249, 8.9322, -3.4366], [-1.4219, 5.7232, -1.7936], [-0.8379, 5.5022, 1.9314], [1.1251, 2.9092, 3.8024],
        [-0.4759, 2.8722, 7.1434], [2.4681, 2.2222, 9.5104], [0.6621, 2.3182, 12.8294], [1.0061, -1.3938, 13.4914],
        [4.5321, -1.7438, 14.9354], [2.9381, -3.0158, 18.1844], [2.1941, -6.1528, 16.3134], [5.5721, -7.1228, 14.9684],
        [8.8321, -8.5638, 16.1924], [12.1631, -7.1808, 14.9824], [12.4731, -9.6798, 12.1044],
        [8.9851, -8.6788, 10.9134],
        [9.8771, -4.9958, 11.1624], [13.0621, -5.6558, 9.1874], [10.9351, -7.4298, 6.5824], [8.2571, -4.6598, 6.5414],
        [11.0031, -2.1628, 6.0734], [12.2061, -3.9058, 2.9004], [8.6461, -3.9998, 1.4934], [8.3211, -0.2838, 2.0914],
        [11.5041, 0.3552, 0.0354], [10.1201, -1.9728, -2.5886], [6.8981, 0.0772, -2.9106], [9.0061, 3.0782, -3.5166],
        [11.1491, 1.3422, -6.1186], [8.1121, 0.0482, -8.0076], [6.7901, 3.6372, -7.8856], [10.0551, 5.0622, -9.1176],
        [9.6291, 3.2252, -12.4606], [5.8431, 3.0102, -12.8316], [4.2841, 4.3572, -16.0276], [1.9391, 6.3862, -13.7376],
        [3.7791, 7.1492, -10.4586], [1.5081, 8.1002, -7.5286], [2.2361, 10.1912, -4.4706], [3.2091, 7.5422, -1.9146],
        [2.5731, 8.3472, 1.7984], [3.8761, 6.7322, 4.8864], [1.5581, 7.7192, 7.7764], [2.2301, 7.1362, 11.4504],
        [5.7821, 6.6082, 10.2704], [8.1271, 6.2952, 13.2624], [9.6951, 4.1532, 15.9534], [11.4411, 0.8672, 15.1714],
        [10.3311, 1.1352, 11.5444], [11.9971, 4.4982, 10.9254], [15.0151, 3.2852, 12.8564], [15.4541, 0.1682, 10.7924],
        [15.0471, 2.2612, 7.6144], [17.7431, 4.9112, 8.4294], [19.9211, 2.0662, 9.6714], [19.7241, 0.1862, 6.3494],
        [19.5611, 3.0962, 3.8354], [21.7821, 5.4572, 5.8444], [19.8161, 8.5282, 4.6974], [19.0561, 7.8102, 1.0004],
        [15.3361, 7.7432, 1.9874], [15.3911, 11.5042, 2.3984], [16.0981, 11.7382, -1.3676], [13.0211, 9.7952, -2.3686],
        [10.4081, 11.6092, -4.4066], [7.3101, 11.4262, -4.6126], [7.3701, 10.0532, -1.1606], [5.8001, 11.6702, 1.8864],
        [6.5751, 10.1082, 5.3124], [4.8351, 11.6562, 8.3164], [4.2411, 11.0422, 12.0454], [0.6261, 12.1252, 11.4504],
        [-2.1679, 9.6072, 10.9244], [-3.7359, 9.4352, 7.4864], [-6.8779, 10.6492, 9.2394], [-4.9789, 13.9222, 10.0014],
        [-3.0299, 14.4162, 6.7624], [-6.2539, 14.0252, 4.8714], [-8.5909, 15.7792, 7.3854], [-10.2029, 17.7522, 4.4904],
        [-10.5969, 14.6642, 2.2844], [-11.8399, 11.9232, 4.6614], [-14.5909, 10.7392, 2.2664],
        [-11.9039, 10.1722, -0.3806],
        [-10.1129, 7.5142, 1.7054], [-10.4299, 3.8002, 0.8164], [-8.9029, 1.2202, 3.1104], [-7.9199, -1.9038, 1.2704],
        [-8.7949, -5.0848, 3.0844], [-9.2589, -8.6608, 1.8774], [-12.1459, -8.8528, 4.4154],
        [-14.3229, -6.2098, 2.7764],
        [-17.5949, -7.1148, 1.0804], [-16.7629, -4.3078, -1.3436], [-14.5729, -4.7718, -4.3436],
        [-12.6229, -2.2468, -6.3516],
        [-13.2269, -2.5438, -10.0506], [-11.1639, 0.5722, -10.9776], [-9.1099, 3.1822, -9.1646],
        [-10.3319, 6.8122, -9.2796],
        [-7.8329, 9.6892, -9.6736], [-9.4019, 11.6922, -6.7926], [-9.1949, 8.8742, -4.1636], [-6.7469, 7.7972, -1.4996],
        [-5.9249, 4.1492, -1.1126], [-4.5489, 2.7622, 2.1774], [-2.4629, -0.3708, 2.6464], [-1.9219, -1.5728, 6.2034],
        [1.7921, -1.6548, 6.8544], [1.5491, -5.0148, 8.6224], [3.4471, -8.3488, 8.0994], [1.7571, -11.7978, 8.4704],
        [-1.4899, -9.9158, 8.5684], [-3.1669, -13.2278, 8.8304], [-2.8199, -13.5438, 12.5144],
        [-5.1539, -10.6428, 12.8884],
        [-8.7789, -11.2988, 12.0084], [-10.4489, -8.3418, 10.2824], [-7.6839, -6.1158, 11.6044],
        [-7.8759, -3.4498, 8.8954],
        [-11.6999, -3.8398, 8.4524], [-12.1939, -3.1198, 12.1604], [-9.9739, -0.0678, 12.0374],
        [-11.4549, 1.6512, 8.9754],
        [-14.9919, 0.5752, 9.9074], [-14.5959, 2.1682, 13.3004], [-13.3849, 5.3632, 11.5744],
        [-16.3689, 5.6452, 9.2734],
        [-14.2779, 5.1342, 6.1214], [-14.9269, 2.8462, 3.1374], [-13.0749, -0.4668, 2.7944],
        [-12.6429, -2.5258, -0.3616],
        [-10.6649, -5.4368, -1.6216], [-8.9439, -5.9768, -4.9546], [-10.9959, -7.8238, -7.5836],
        [-8.5889, -10.7268, -7.8676],
        [-10.4589, -13.7418, -6.4166], [-10.5609, -15.5748, -9.8136], [-6.6859, -15.4558, -9.9476],
        [-5.5719, -16.3638, -6.4336],
        [-6.2129, -19.3378, -4.1076], [-7.8779, -18.0248, -0.9176], [-4.9819, -19.3928, 1.2124],
        [-2.4439, -17.5498, -0.9446],
        [-4.5659, -14.4188, -1.0346], [-4.0879, -13.9968, 2.7334], [-0.2609, -14.1888, 2.2074],
        [0.0681, -11.1268, -0.1716],
        [2.6831, -8.6418, 0.9614], [2.5141, -4.8518, 1.2714], [4.5561, -4.2778, -1.9446], [2.6031, -6.9268, -3.7946],
        [-0.6899, -5.0908, -3.1306], [1.0341, -1.7878, -4.0546], [2.5661, -3.3088, -7.2426],
        [-0.8199, -4.6418, -8.2996],
        [-2.3259, -1.1448, -7.9486], [0.5101, 0.5752, -9.7126], [0.5471, -2.0128, -12.4686],
        [-3.2799, -1.5858, -12.7866],
        [-2.7999, 2.0222, -13.7486], [-0.5569, 0.9422, -16.5496], [-2.6369, -1.8848, -18.1006],
        [-6.1569, -1.0548, -16.7686],
        [-6.6249, -4.8228, -16.7026], [-6.7119, -6.4458, -13.2336], [-5.5179, -9.8148, -14.5286],
        [-2.5329, -8.5138, -16.5686],
        [-1.6539, -6.5468, -13.4306], [-2.0149, -9.4518, -11.0816], [-0.0839, -11.9018, -13.2466],
        [2.7401, -9.4488, -13.6226],
        [3.2161, -9.4268, -9.8486], [2.6201, -13.0058, -8.8006], [3.7691, -15.6788, -11.2596]
    ])

    # 2. Cluster Index a_idx
    a_idx = np.array([
        0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3,

        3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5,

        5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 8,

        8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10,

        10, 10, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13,

        13, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15,

        16, 16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18, 18, 19, 19, 19, 19,

        19, 20, 20, 20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 21,

        21, 22, 22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,

        24, 24, 24, 24, 24, 24, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 26, 26,

        26, 26, 26, 26, 26, 26, 27
    ])

    return x_ca, a_idx


def fit_ellipsoid_exact(points):
    """
    实现 PyTorch 代码中的逻辑：
    1. 计算中心 (Mean)
    2. 计算协方差 (Covariance)
    3. 特征分解 (Eigendecomposition) -> R (旋转) 和 特征值
    4. Exact Fit Scaling: 找到离中心马氏距离最大的点，放大椭球以包裹它。

    返回:
        mu (3,): 中心
        radii (3,): 三个轴的半轴长 (s0, s1, s2)
        R (3, 3): 旋转矩阵
    """
    if len(points) < 2:
        # 只有一个点或空，返回一个极小的球
        return np.mean(points, axis=0), np.array([0.1, 0.1, 0.1]), np.eye(3)

    # 1. Center
    mu = np.mean(points, axis=0)

    # 2. Covariance
    # 注意: PyTorch 代码中用了 scatter / (cnt - 1)，这里 np.cov 默认是除以 (N-1)
    cov = np.cov(points, rowvar=False)

    # 安全处理：如果 cov 是标量（例如点完全共线或重合），加一点 epsilon
    if cov.ndim < 2:
        cov = np.eye(3) * 1e-6

    # 3. Eigendecomposition
    # np.linalg.eigh 返回升序特征值 w[0]<=w[1]<=w[2]
    eigvals, eigvecs = np.linalg.eigh(cov)

    # 强制特征值为正 (防止数值误差)
    eigvals = np.maximum(eigvals, 1e-6)

    # 4. Rotation Matrix & Handedness Fix
    R = eigvecs
    # 如果行列式为负，翻转第一列，保证右手系
    if np.linalg.det(R) < 0:
        R[:, 0] = -R[:, 0]

    # 5. Exact Fit Scaling (关键步骤)
    # 将所有点变换到“主轴对齐且缩放归一”的空间
    # delta = (x - mu)
    # local = delta @ R
    # norm_dist_sq = sum((local_i / sigma_i)^2)

    delta = points - mu
    local_coords = delta @ R  # 投影到主轴方向

    # 计算马氏距离平方: d^2 = x^2/lambda_0 + y^2/lambda_1 + z^2/lambda_2
    norm_dist_sq = np.sum(local_coords ** 2 / eigvals, axis=1)

    # 找到最大的距离
    max_sq_val = np.max(norm_dist_sq)
    scale_factor = np.sqrt(max_sq_val)

    # 6. Final Radii
    # 原始标准差 sqrt(lambda) * 缩放因子
    radii = np.sqrt(eigvals) * scale_factor

    return mu, radii, R


def plot_all_clusters():
    x_ca, a_idx = get_data()

    # 获取唯一的 cluster ID
    unique_clusters = np.unique(a_idx)

    fig = plt.figure(figsize=(14, 10))
    ax = fig.add_subplot(111, projection='3d')

    # 颜色映射
    cmap = plt.get_cmap('tab20')

    # 用于计算总的包围盒，保证显示比例正确
    all_plot_points = []

    print(f"Total points: {len(x_ca)}")
    print(f"Processing {len(unique_clusters)} clusters...")

    # 遍历每个 Cluster
    for k in unique_clusters:
        # 1. 提取当前 Cluster 的点
        mask = (a_idx == k)
        points = x_ca[mask]

        color = cmap(k % 20)

        # 2. 绘制原始点
        ax.scatter(points[:, 0], points[:, 1], points[:, 2], color=color, s=20, alpha=0.6)
        all_plot_points.append(points)

        # 3. 计算椭球参数
        mu, radii, R = fit_ellipsoid_exact(points)

        print(f"Cluster {k}: Center={mu[:2]}..., Radii={radii}")
        # 3. 绘制标签 (NEW! 核心修改)
        # 在椭球中心位置 (mu) 写上 Cluster ID
        ax.text(mu[0], mu[1], mu[2],
                f"{int(k)}",  # 文本内容
                color='black',  # 字体颜色
                fontsize=12,  # 字体大小
                fontweight='bold',  # 加粗
                zorder=10)  # 保证文字显示在最上层

        # 4. 绘制椭球 (Wireframe)
        # 生成单位球
        u = np.linspace(0, 2 * np.pi, 15)  # 经度分辨率
        v = np.linspace(0, np.pi, 10)  # 纬度分辨率
        x_unit = np.outer(np.cos(u), np.sin(v))
        y_unit = np.outer(np.sin(u), np.sin(v))
        z_unit = np.outer(np.ones_like(u), np.cos(v))

        # 缩放
        x_scaled = x_unit * radii[0]
        y_scaled = y_unit * radii[1]
        z_scaled = z_unit * radii[2]

        # 旋转 & 平移
        # 展平以便矩阵运算 [3, N]
        coords = np.stack([x_scaled.flatten(), y_scaled.flatten(), z_scaled.flatten()])
        coords_world = (R @ coords).T + mu

        # 恢复网格形状
        Xw = coords_world[:, 0].reshape(x_unit.shape)
        Yw = coords_world[:, 1].reshape(y_unit.shape)
        Zw = coords_world[:, 2].reshape(z_unit.shape)

        ax.plot_wireframe(Xw, Yw, Zw, color=color, alpha=0.4, linewidth=1)

        # 5. 绘制长轴方向 (Optional, visual aid)
        # radii[2] 是最大的 (eigh 升序)，R[:, 2] 是对应方向
        long_axis = R[:, 2] * radii[2]
        ax.quiver(mu[0], mu[1], mu[2], long_axis[0], long_axis[1], long_axis[2],
                  color=color, length=1.0, linestyle='-', linewidth=1.5)

    # --- 设置“等比例”视角 ---
    # Matplotlib 3D 默认会拉伸轴以填充立方体，这里手动校正
    all_coords = np.vstack(all_plot_points)
    max_range = (all_coords.max(0) - all_coords.min(0)).max() / 2.0
    mid = (all_coords.max(0) + all_coords.min(0)) * 0.5

    ax.set_xlim(mid[0] - max_range, mid[0] + max_range)
    ax.set_ylim(mid[1] - max_range, mid[1] + max_range)
    ax.set_zlim(mid[2] - max_range, mid[2] + max_range)

    ax.set_xlabel('X')
    ax.set_ylabel('Y')
    ax.set_zlabel('Z')
    ax.set_title(f"Reconstructed Parents from {len(unique_clusters)} Clusters (Exact Fit)")

    plt.show()


if __name__ == "__main__":
    plot_all_clusters()