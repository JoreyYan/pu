# SH Density Decoder v5 结果分析

**训练时间**: 2025-10-18 20:34 - 2025-10-19 02:29  
**最终Epoch**: 136  
**Global Step**: 257285  
**WandB Run**: w292ivef

---

## 配置变更 (v4 → v5)

| 参数 | v4 (Epoch 27) | v5 (Epoch 136) |
|------|---------------|----------------|
| `type_loss_weight` | 1.0 | **0.0** (关闭) |
| `atom_loss_weight` | 0.2 | **1.0** (提高5倍) |
| `sh_tau_threshold` | 0.2 | **0.0** (移除threshold) |
| Warm start | - | Epoch 27 checkpoint |

**假设**: tau=0.2过滤掉了远端原子的低密度信号 → 移除后应改善

---

## 验证集结果对比

### 整体指标

| 指标 | v4 (Epoch 27) | v5 (Epoch 136) | 变化 |
|------|---------------|----------------|------|
| **整体 atom14 RMSD** | 1.67Å | **1.67Å** | 0.00Å ❌ |
| **侧链 RMSD (atom4-13)** | 2.21Å | **2.21Å** | 0.00Å ❌ |
| **序列准确率** | 98.7% | **61.1%** | -37.6% ⚠️ |
| **Perplexity** | ~1.8 | **96.5** | +94.7 ⚠️ |

### Per-Atom RMSD详细对比

#### 主链原子 (atom0-3)
| Atom | 名称 | v4 | v5 | 变化 |
|------|------|----|----|------|
| atom0 | N | 0.73Å | **0.72Å** | -0.01Å ✅ |
| atom1 | CA | 0.54Å | **0.54Å** | 0.00Å |
| atom2 | C | 0.84Å | **0.83Å** | -0.01Å ✅ |
| atom3 | O | 1.23Å | **1.23Å** | 0.00Å |

#### 侧链原子 (atom4-13)
| Atom | v4 | v5 | 变化 | 状态 |
|------|----|----|------|------|
| atom4 (CB) | 0.34Å | **0.34Å** | 0.00Å | ❌ 无改善 |
| atom5 | 1.23Å | **1.22Å** | -0.01Å | ✅ 微改善 |
| atom6 | 1.93Å | **1.92Å** | -0.01Å | ✅ 微改善 |
| atom7 | 2.55Å | **2.54Å** | -0.01Å | ✅ 微改善 |
| atom8 | 3.62Å | **3.62Å** | 0.00Å | ❌ 无改善 |
| atom9 | 3.73Å | **3.73Å** | 0.00Å | ❌ 无改善 |
| **atom10** | **4.27Å** | **4.28Å** | **+0.01Å** | ❌ **轻微恶化** |
| **atom11** | **5.07Å** | **5.07Å** | **0.00Å** | ❌ **无改善** |
| atom12 | 3.96Å | **3.96Å** | 0.00Å | ❌ 无改善 |
| atom13 | 4.75Å | **4.75Å** | 0.00Å | ❌ 无改善 |

---

## 关键发现

### ❌ **坐标精度：几乎无改善**

**远端原子 (atom10-13) 目标**: 4-5Å → < 3Å  
**实际结果**: 4.28/5.07/3.96/4.75Å (变化 < 0.01Å)

**结论**:
1. 移除tau threshold **没有改善远端原子RMSD**
2. 提高atom_loss_weight 5倍 **没有效果**
3. 训练136 epochs (从27继续) **精度饱和**

### ⚠️ **序列预测：严重退化**

| 指标 | v4 | v5 | 说明 |
|------|----|----|------|
| 准确率 | 98.7% | 61.1% | **下降37.6%** |
| Perplexity | 1.8 | 96.5 | **爆炸54倍** |

**原因分析**:
- `type_loss_weight=0.0` 导致模型**完全放弃学习序列预测**
- 虽然坐标loss权重提高，但**没有足够信号改善几何精度**
- 模型陷入局部最优：主链+近端侧链精度高，远端原子无法进一步优化

---

## 实验结论

### 1. **假设被证伪**
> tau=0.2过滤掉了远端原子的低密度信号

**证据**: 移除tau后远端RMSD无改善 → **tau不是瓶颈**

### 2. **Loss权重调整无效**
- `atom_loss_weight: 0.2 → 1.0` (5倍提升)
- `type_loss_weight: 1.0 → 0.0` (关闭)
- 结果: **坐标RMSD无变化，序列预测崩溃**

### 3. **根本问题：信息瓶颈**
SH密度表示 `[N,C=4,L+1=9,2L+1=17,R=16]` **无法编码远端原子的精细位置**

**理由**:
- CB (atom4) 精度高 (0.34Å) → SH能编码近端几何
- atom10-13 (4-5Å) → SH对远端原子分辨率不足
- 长时间训练无改善 → **不是优化问题，是表示能力问题**

---

## 与R3 Diffusion对比

| 指标 | R3 Diffusion (Epoch 129) | SH Decoder v5 (Epoch 136) | 优势 |
|------|--------------------------|---------------------------|------|
| **键长精度** | < 0.03Å | N/A (未测) | R3 |
| **芳香环平面性** | 97.2% | N/A (未测) | R3 |
| **CB RMSD** | < 0.5Å (估计) | 0.34Å | **SH** ✅ |
| **远端原子RMSD** | < 1Å (估计) | 4-5Å | **R3** ✅ |
| **序列-几何一致性** | 未评估 | 未评估 | - |

**关键差异**:
- R3直接扩散atom14坐标 → **无信息损失**
- SH先编码后解码 → **信息瓶颈** (尤其远端原子)

---

## 建议

### 🔴 **停止SH Density方向**

**原因**:
1. 远端原子RMSD (4-5Å) **不可接受**
2. 长时间训练 (27→136 epochs) **无改善**
3. 调整loss/tau threshold **均无效**
4. R3 diffusion已达到97.2%几何质量

### 🟢 **回归R3 Diffusion + 评估type-geometry问题**

**实验计划**:
1. 用R3 diffusion生成backbone
2. ProteinMPNN填序列 → AlphaFold2预测
3. 检查侧链clash/空腔合理性
4. **如果R3+MPNN已足够好 → 无需SH**
5. 如果确实有type错配 → 考虑在R3空间加type conditioning (不用SH)

---

## 最终结论

**SH密度解码是一个死胡同**:
- 理论优势 (元素通道编码type-geometry耦合) **未体现**
- 实际劣势 (信息压缩导致远端精度差) **很明显**
- 训练成本 (136 epochs, 6小时) **没有回报**

**R3 diffusion是更好的选择**:
- 几何质量优秀 (97.2%)
- 无需额外编码/解码
- 训练更稳定

**下一步**: 系统评估R3+MPNN的type-geometry一致性，如果合格则直接使用。

---

**实验路径**: `/home/junyu/project/pu/ckpt/se3-fm_sh/pdb__SH_to_atoms_decoder_v5/`  
**WandB**: `https://wandb.ai/joreyyanan/se3-fm_sh/runs/w292ivef`  
**日期**: 2025-10-30
